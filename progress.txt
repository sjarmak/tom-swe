## Codebase Patterns
- Zod v4 is used (import from 'zod', use z.strictObject for strict mode)
- TypeScript with strict mode, noUncheckedIndexedAccess, noUnusedLocals/Parameters
- tsconfig includes only tom/**/*.ts
- Use vitest for testing (npm test runs vitest run)
- Module system: commonjs with Node16 module resolution
- Schemas and inferred types exported from tom/schemas.ts
- Memory paths: global = ~/.claude/tom/, project = .claude/tom/
- Scope pattern: functions accept 'global' | 'project' scope parameter, readUserModel also accepts 'merged'
- BM25 index is JSON-serializable — use buildIndex to create, search to query, JSON.parse to restore from cache
- noUncheckedIndexedAccess: always use `?? defaultValue` when accessing Record fields
- Preference functions are pure and immutable — reinforcePreference, decayPreferences, resolveConflicts all return new arrays
- PreferenceCategory type: 'interactionStyle' | 'codingPreferences' | 'emotionalSignals'
- Exponential decay formula: confidence * 2^(-daysSinceUpdate / halfLifeDays)
- Aggregation pipeline: decay existing → extract observations → reinforce → resolve conflicts
- Hook scripts live in tom/hooks/ — shell scripts delegate to TypeScript helpers for logic
- isTomEnabled() reads tom.enabled from ~/.claude/settings.json — used as guard in all hooks
- Session ID: CLAUDE_SESSION_ID env var or fallback to `pid-${process.pid}`
- SessionModel fields map to categories: codingPreferences→'codingPreferences', interactionPatterns→'interactionStyle', satisfactionSignals→'emotionalSignals'
---

## 2026-02-02 - US-002
- Implemented tom/memory-io.ts with file I/O utilities for all 3 memory tiers
- Functions: readSessionLog, writeSessionLog, readSessionModel, writeSessionModel, readUserModel, writeUserModel
- Path helpers exported for use by other modules (globalTomDir, projectTomDir, etc.)
- readUserModel('merged') merges global and project models with project-level overriding global-level preferences
- All read functions validate against Zod schemas, return null on missing/invalid files
- All write functions validate before writing, create directories on first write
- Files changed: tom/memory-io.ts (new), tom/memory-io.test.ts (new), package.json (added vitest, test script)
- **Learnings for future iterations:**
  - os.homedir() gives the HOME path on all platforms — used for global ~/.claude/tom/ path
  - process.cwd() used for project-level .claude/tom/ path
  - Zod v4 safeParse returns { success, data } or { success, error } — use result.success guard
  - Tests override HOME and cwd via process.env and process.cwd for isolation
  - tsconfig has noUnusedLocals — don't declare unused variables in test files
---

## 2026-02-02 - US-003
- Implemented tom/bm25.ts with zero-dependency BM25 search index and query engine
- buildIndex: tokenizes documents, computes term frequencies and IDF values
- search: scores documents using Okapi BM25 formula with tier weighting (Tier 3 = 3x, Tier 2 = 2x, Tier 1 = 1x)
- Index is fully JSON-serializable (plain objects, no class instances)
- 12 tests passing including performance test (100 queries over 100 docs in <200ms)
- Files changed: tom/bm25.ts (new), tom/bm25.test.ts (new)
- **Learnings for future iterations:**
  - BM25 parameters K1=1.2 and B=0.75 are standard Okapi BM25 defaults
  - Tier weighting is applied as a multiplier on the final BM25 score, not on individual term scores
  - Index stores pre-computed IDF values so search only needs to compute per-document TF scores
  - Tokenization is simple whitespace/non-word split + lowercase — sufficient for preference matching
  - noUncheckedIndexedAccess requires `?? 0` for all record lookups
---

## 2026-02-02 - US-004
- Implemented tom/preferences.ts with preference tracking, confidence scoring, and decay
- reinforcePreference: increases confidence by 0.1 per match (capped at 1.0), adds new prefs at 0.1
- decayPreferences: exponential decay using half-life formula, removes prefs below 0.01 threshold
- resolveConflicts: recency-weighted voting — most recently updated value wins for same category+key
- 16 tests passing covering reinforcement, decay, conflict resolution, immutability, all 3 categories
- Files changed: tom/preferences.ts (new), tom/preferences.test.ts (new)
- **Learnings for future iterations:**
  - When same category+key has different values, both are kept until resolveConflicts is called
  - Decay removes preferences below 0.01 threshold to prevent zombie preferences
  - Optional chaining with comparison operators causes TS2532 under noUncheckedIndexedAccess — extract to variable with `?? ''` first
  - PreferenceObservation is the input type for reinforcement (category, key, value only — no confidence/timestamps)
---

## 2026-02-02 - US-005
- Implemented tom/aggregation.ts with cross-session preference aggregation
- aggregateSessionIntoModel: takes UserModel + SessionModel, returns new UserModel (immutable)
- Pipeline: decay existing prefs → extract observations from session → reinforce/add prefs → resolve conflicts
- extractObservations maps SessionModel fields to PreferenceObservation: codingPreferences→'codingPreferences', interactionPatterns→'interactionStyle', satisfactionSignals→'emotionalSignals'
- 12 tests passing covering new prefs, reinforcement, decay, immutability, emotional signals, empty sessions
- Files changed: tom/aggregation.ts (new), tom/aggregation.test.ts (new), prd.json, progress.txt
- **Learnings for future iterations:**
  - SessionModel.satisfactionSignals are converted to individual emotionalSignals preferences (frustration, satisfaction, urgency as separate keys)
  - resolveConflicts is called after reinforcement to deduplicate same category+key entries
  - Default decay half-life is 30 days, configurable via parameter
  - noUnusedLocals catches unused imports like `vi` from vitest — only import what you use
---

## 2026-02-02 - US-006
- Implemented tom/hooks/post-tool-use.sh and tom/hooks/capture-interaction.ts for session capture
- Shell script runs the TypeScript helper in the background for <10ms completion
- capture-interaction.ts: sanitizes secrets (15 patterns), extracts parameter shapes, truncates long values
- Session files stored at ~/.claude/tom/sessions/{session-id}.json with CLAUDE_SESSION_ID or PID fallback
- Uses async fs.writeFile for fire-and-forget persistence (no validation on write path)
- isTomEnabled guard reads tom.enabled from ~/.claude/settings.json
- 26 tests passing covering sanitization, capture, session management, main entry point
- Files changed: tom/hooks/post-tool-use.sh (new), tom/hooks/capture-interaction.ts (new), tom/hooks/capture-interaction.test.ts (new)
- **Learnings for future iterations:**
  - Claude Code hooks receive env vars: TOOL_NAME, TOOL_INPUT, TOOL_OUTPUT
  - Shell hooks should background Node processes for speed: `node script.js &`
  - fs.writeFile (async) with no-op callback for fire-and-forget writes
  - Settings file is at ~/.claude/settings.json — read tom.enabled from there
  - Secret patterns cover: sk-*, ghp_*, gho_*, ghs_*, github_pat_*, Bearer, Basic, xox[bposa]-, AKIA*, eyJ* (JWT), password=, npm_*, pypi-*
  - Values > 200 chars are treated as file contents and redacted
---
