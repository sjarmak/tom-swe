## Codebase Patterns
- Zod v4 is used (import from 'zod', use z.strictObject for strict mode)
- Agent tools use immutable state pattern: functions accept AgentInvocationState and return { result, state } tuples
- Agent definition is a markdown file (tom/agent/tom-agent.md) with config in TypeScript (tom/agent/config.ts)
- Tool implementations live in tom/agent/tools.ts — 5 tools: search_memory, read_memory_file, analyze_session, initialize_user_profile, give_suggestions
- Memory operation limit enforced via MEMORY_OPERATION_TOOLS set and isMemoryOperationAllowed guard
- TypeScript with strict mode, noUncheckedIndexedAccess, noUnusedLocals/Parameters
- tsconfig includes only tom/**/*.ts
- Use vitest for testing (npm test runs vitest run)
- Module system: commonjs with Node16 module resolution
- Schemas and inferred types exported from tom/schemas.ts
- Memory paths: global = ~/.claude/tom/, project = .claude/tom/
- Scope pattern: functions accept 'global' | 'project' scope parameter, readUserModel also accepts 'merged'
- BM25 index is JSON-serializable — use buildIndex to create, search to query, JSON.parse to restore from cache
- noUncheckedIndexedAccess: always use `?? defaultValue` when accessing Record fields
- Preference functions are pure and immutable — reinforcePreference, decayPreferences, resolveConflicts all return new arrays
- PreferenceCategory type: 'interactionStyle' | 'codingPreferences' | 'emotionalSignals'
- Exponential decay formula: confidence * 2^(-daysSinceUpdate / halfLifeDays)
- Aggregation pipeline: decay existing → extract observations → reinforce → resolve conflicts
- Ambiguity detection is pure heuristic (no I/O, no model calls) — 4 heuristics scored and summed, clamped to 0-1
- AmbiguityThreshold maps to numeric cutoffs: low=0.3, medium=0.5, high=0.7
- PreToolUse hook runs synchronously (not backgrounded) because output goes to stdout for context injection
- BM25Index structure: { documentCount, avgDocLength, docs: IndexedDoc[], idf: Record<string, number> } — IndexedDoc has id, tier, length, termFreqs
- consultToM pipeline: detect ambiguity → search BM25 index (if cached) → fallback to user model → generate ToMSuggestion → log usage
- Hook scripts live in tom/hooks/ — shell scripts delegate to TypeScript helpers for logic
- isTomEnabled() reads tom.enabled from ~/.claude/settings.json — used as guard in all hooks
- Session ID: CLAUDE_SESSION_ID env var or fallback to `pid-${process.pid}`
- SessionModel fields map to categories: codingPreferences→'codingPreferences', interactionPatterns→'interactionStyle', satisfactionSignals→'emotionalSignals'
- Stop hook pattern: shell script backgrounds Node process, TypeScript helper runs full pipeline (read Tier 1 → extract Tier 2 → aggregate Tier 3 → rebuild BM25 → log usage)
- Skills live in tom/skills/ — TypeScript modules exporting getX/formatX/main pattern, entry point via `if (require.main === module)`
- BM25 index cached at ~/.claude/tom/bm25-index.json after rebuild
- Usage log at ~/.claude/tom/usage.log — JSON lines format, one entry per operation
- Centralized config: tom/config.ts exports readTomConfig() (full validated config) and isTomEnabled() (boolean guard) — reads from tom key in ~/.claude/settings.json
- Model routing: tom/routing.ts provides getModelForOperation(type) and centralized logUsage — reads from tom.models.{memoryUpdate,consultation} in settings.json
- profileInit shares the 'consultation' config key (both default to 'sonnet')
---

## 2026-02-02 - US-002
- Implemented tom/memory-io.ts with file I/O utilities for all 3 memory tiers
- Functions: readSessionLog, writeSessionLog, readSessionModel, writeSessionModel, readUserModel, writeUserModel
- Path helpers exported for use by other modules (globalTomDir, projectTomDir, etc.)
- readUserModel('merged') merges global and project models with project-level overriding global-level preferences
- All read functions validate against Zod schemas, return null on missing/invalid files
- All write functions validate before writing, create directories on first write
- Files changed: tom/memory-io.ts (new), tom/memory-io.test.ts (new), package.json (added vitest, test script)
- **Learnings for future iterations:**
  - os.homedir() gives the HOME path on all platforms — used for global ~/.claude/tom/ path
  - process.cwd() used for project-level .claude/tom/ path
  - Zod v4 safeParse returns { success, data } or { success, error } — use result.success guard
  - Tests override HOME and cwd via process.env and process.cwd for isolation
  - tsconfig has noUnusedLocals — don't declare unused variables in test files
---

## 2026-02-02 - US-003
- Implemented tom/bm25.ts with zero-dependency BM25 search index and query engine
- buildIndex: tokenizes documents, computes term frequencies and IDF values
- search: scores documents using Okapi BM25 formula with tier weighting (Tier 3 = 3x, Tier 2 = 2x, Tier 1 = 1x)
- Index is fully JSON-serializable (plain objects, no class instances)
- 12 tests passing including performance test (100 queries over 100 docs in <200ms)
- Files changed: tom/bm25.ts (new), tom/bm25.test.ts (new)
- **Learnings for future iterations:**
  - BM25 parameters K1=1.2 and B=0.75 are standard Okapi BM25 defaults
  - Tier weighting is applied as a multiplier on the final BM25 score, not on individual term scores
  - Index stores pre-computed IDF values so search only needs to compute per-document TF scores
  - Tokenization is simple whitespace/non-word split + lowercase — sufficient for preference matching
  - noUncheckedIndexedAccess requires `?? 0` for all record lookups
---

## 2026-02-02 - US-004
- Implemented tom/preferences.ts with preference tracking, confidence scoring, and decay
- reinforcePreference: increases confidence by 0.1 per match (capped at 1.0), adds new prefs at 0.1
- decayPreferences: exponential decay using half-life formula, removes prefs below 0.01 threshold
- resolveConflicts: recency-weighted voting — most recently updated value wins for same category+key
- 16 tests passing covering reinforcement, decay, conflict resolution, immutability, all 3 categories
- Files changed: tom/preferences.ts (new), tom/preferences.test.ts (new)
- **Learnings for future iterations:**
  - When same category+key has different values, both are kept until resolveConflicts is called
  - Decay removes preferences below 0.01 threshold to prevent zombie preferences
  - Optional chaining with comparison operators causes TS2532 under noUncheckedIndexedAccess — extract to variable with `?? ''` first
  - PreferenceObservation is the input type for reinforcement (category, key, value only — no confidence/timestamps)
---

## 2026-02-02 - US-005
- Implemented tom/aggregation.ts with cross-session preference aggregation
- aggregateSessionIntoModel: takes UserModel + SessionModel, returns new UserModel (immutable)
- Pipeline: decay existing prefs → extract observations from session → reinforce/add prefs → resolve conflicts
- extractObservations maps SessionModel fields to PreferenceObservation: codingPreferences→'codingPreferences', interactionPatterns→'interactionStyle', satisfactionSignals→'emotionalSignals'
- 12 tests passing covering new prefs, reinforcement, decay, immutability, emotional signals, empty sessions
- Files changed: tom/aggregation.ts (new), tom/aggregation.test.ts (new), prd.json, progress.txt
- **Learnings for future iterations:**
  - SessionModel.satisfactionSignals are converted to individual emotionalSignals preferences (frustration, satisfaction, urgency as separate keys)
  - resolveConflicts is called after reinforcement to deduplicate same category+key entries
  - Default decay half-life is 30 days, configurable via parameter
  - noUnusedLocals catches unused imports like `vi` from vitest — only import what you use
---

## 2026-02-02 - US-006
- Implemented tom/hooks/post-tool-use.sh and tom/hooks/capture-interaction.ts for session capture
- Shell script runs the TypeScript helper in the background for <10ms completion
- capture-interaction.ts: sanitizes secrets (15 patterns), extracts parameter shapes, truncates long values
- Session files stored at ~/.claude/tom/sessions/{session-id}.json with CLAUDE_SESSION_ID or PID fallback
- Uses async fs.writeFile for fire-and-forget persistence (no validation on write path)
- isTomEnabled guard reads tom.enabled from ~/.claude/settings.json
- 26 tests passing covering sanitization, capture, session management, main entry point
- Files changed: tom/hooks/post-tool-use.sh (new), tom/hooks/capture-interaction.ts (new), tom/hooks/capture-interaction.test.ts (new)
- **Learnings for future iterations:**
  - Claude Code hooks receive env vars: TOOL_NAME, TOOL_INPUT, TOOL_OUTPUT
  - Shell hooks should background Node processes for speed: `node script.js &`
  - fs.writeFile (async) with no-op callback for fire-and-forget writes
  - Settings file is at ~/.claude/settings.json — read tom.enabled from there
  - Secret patterns cover: sk-*, ghp_*, gho_*, ghs_*, github_pat_*, Bearer, Basic, xox[bposa]-, AKIA*, eyJ* (JWT), password=, npm_*, pypi-*
  - Values > 200 chars are treated as file contents and redacted
---

## 2026-02-02 - US-007
- Implemented ToM sub-agent definition with system prompt and 5 tool implementations
- Agent definition: tom/agent/tom-agent.md (markdown system prompt with core principles, tool docs, reasoning framework)
- Agent config: tom/agent/config.ts (name, model=haiku, temperature=0.1, maxMemoryOperations=3)
- Tool implementations: tom/agent/tools.ts with immutable state tracking for operation limits
- 5 tools: search_memory (BM25), read_memory_file (tier 1/2/3), analyze_session (heuristic extraction), initialize_user_profile (bootstrap from sessions), give_suggestions (validated ToMSuggestion output)
- analyzeSession performs heuristic extraction: intent from tool usage patterns, frustration from error outcomes, urgency from interaction count
- buildMemoryIndex aggregates all 3 tiers into a single BM25 index for search_memory
- 33 new tests (25 tools + 8 config) all passing, 115 total tests passing
- Files changed: tom/agent/tom-agent.md (new), tom/agent/config.ts (new), tom/agent/tools.ts (new), tom/agent/tools.test.ts (new), tom/agent/config.test.ts (new)
- **Learnings for future iterations:**
  - Agent tools use { result, state } tuple return pattern to enforce operation limits immutably
  - analyzeSession extracts SessionModel heuristically: tool frequency for intent, error keywords for frustration, interaction count for urgency
  - buildMemoryIndex reads all files from sessions/, session-models/, and user-model.json into BM25 documents
  - initializeUserProfile and giveSuggestions do NOT count as memory operations (always allowed)
  - MEMORY_OPERATION_TOOLS is a Set containing only search_memory, read_memory_file, analyze_session
---

## 2026-02-02 - US-008
- Implemented session analysis Stop hook with shell script and TypeScript helper
- tom/hooks/stop-analyze.sh: backgrounds the TypeScript helper so it does not block session exit
- tom/hooks/stop-analyze.ts: full analysis pipeline — reads Tier 1, extracts Tier 2, aggregates Tier 3, rebuilds BM25 index, logs to usage.log
- Pipeline: readRawSessionLog → extractSessionModel → writeSessionModel → aggregateSessionIntoModel → writeUserModel → buildMemoryIndex → save index → logUsage
- Reuses buildMemoryIndex from agent/tools.ts for BM25 index rebuilding
- extractSessionModel mirrors the heuristic extraction logic from agent/tools.ts (same algorithm)
- 31 new tests covering: isTomEnabled, getSessionId, readRawSessionLog, extractSessionModel, logUsage, analyzeCompletedSession, main entry point
- 146 total tests passing
- Files changed: tom/hooks/stop-analyze.sh (new), tom/hooks/stop-analyze.ts (new), tom/hooks/stop-analyze.test.ts (new), prd.json, progress.txt
- **Learnings for future iterations:**
  - Stop hooks run after the session ends — background the Node process so exit is not blocked
  - analyzeCompletedSession handles missing user model gracefully by creating empty model as base for aggregation
  - logUsage uses fs.appendFileSync for JSON lines — one JSON object per line, easy to parse
  - BM25 index is saved to bm25-index.json after rebuild for future cache reads
  - Error handling in main() catches and logs to usage.log with 'session-analysis-error' operation type, writes to stderr, never throws
  - Tests use fs.mkdtempSync for temp dirs and process.env override for HOME — same pattern as capture-interaction tests
---

## 2026-02-02 - US-009
- Implemented tom/ambiguity.ts with lightweight ambiguity detection heuristics
- detectAmbiguity function: takes tool name, parameters, recent messages, threshold, and hasUserModel flag
- 4 heuristics scored independently and summed: short/vague instructions (0-0.35), multiple file targets (0-0.3), preference-sensitive decisions (0-0.35), no user model (0-0.25)
- Score clamped to 0-1, compared against configurable threshold (low=0.3, medium=0.5, high=0.7)
- Pure functions, no I/O, <50ms execution (verified with 1000-iteration perf test)
- 27 tests passing covering all heuristics, thresholds, combined scenarios, and performance
- 173 total tests passing
- Files changed: tom/ambiguity.ts (new), tom/ambiguity.test.ts (new), prd.json, progress.txt
- **Learnings for future iterations:**
  - Vague keyword detection uses a fixed list: fix, improve, update, change, make, do, handle, better, clean, nice
  - Preference keywords: style, pattern, architecture, library, framework, convention, approach, design, structure, organize, refactor, naming, format
  - Style-sensitive tools: Write, Edit, NotebookEdit — get extra ambiguity score
  - FILE_PATH_PATTERN regex detects paths like /src/foo.ts in user messages to reduce false positives
  - Score contributions are additive — multiple heuristics firing makes ambiguity more certain
  - noUnusedParameters catches unused function params — remove or prefix with underscore
---

## 2026-02-02 - US-010
- Implemented tom/hooks/pre-tool-use.sh and tom/hooks/pre-tool-use.ts for in-session consultation
- Shell script runs TypeScript helper synchronously (not backgrounded) — output goes to stdout for Claude Code context injection
- pre-tool-use.ts: reads tom settings, runs ambiguity detection, searches BM25 index or user model, generates ToMSuggestion
- Consultation pipeline: detectAmbiguity → loadCachedIndex → search/fallback to user model → buildSuggestion → logUsage
- If ambiguity below threshold, script exits immediately with no output (no-op)
- readTomSettings reads both tom.enabled and tom.consultThreshold from settings.json
- 27 tests passing covering settings, ambiguity detection, BM25 search, user model fallback, main entry point
- 200 total tests passing
- Files changed: tom/hooks/pre-tool-use.sh (new), tom/hooks/pre-tool-use.ts (new), tom/hooks/pre-tool-use.test.ts (new), prd.json, progress.txt
- **Learnings for future iterations:**
  - PreToolUse hook must run synchronously (not backgrounded) because its stdout is injected as context
  - BM25Index JSON structure uses `docs` (array of IndexedDoc with id/tier/length/termFreqs) and `idf` (not `idfValues`)
  - When mocking BM25 index in tests, must match the exact BM25Index interface structure
  - consultToM tries BM25 search first, then falls back to reading user model directly if no index or no results
  - ToMSuggestion type field: 'style' for style/preference reasons, 'disambiguation' for general ambiguity, 'preference' for direct user model reads
  - process.stdout.write can be intercepted in tests by replacing it — remember to restore in afterEach
---

## 2026-02-02 - US-011
- Implemented tom/routing.ts with smart model routing configuration and centralized usage logging
- getModelForOperation: reads tom.models.{memoryUpdate,consultation} from ~/.claude/settings.json, returns configured model or defaults (haiku for memoryUpdate, sonnet for consultation/profileInit)
- logUsage: appends { timestamp, operation, model, tokenCount } as JSON lines to ~/.claude/tom/usage.log
- profileInit maps to 'consultation' config key (shares the same setting)
- 14 tests covering all operation types, config reading, fallbacks, invalid JSON, missing files, log creation, multi-entry append
- 214 total tests passing
- Files changed: tom/routing.ts (new), tom/routing.test.ts (new), prd.json, progress.txt
- **Learnings for future iterations:**
  - logUsage exists in stop-analyze.ts and pre-tool-use.ts already — future refactor could consolidate them to use routing.ts version
  - Settings structure: tom.models.memoryUpdate and tom.models.consultation are the two config keys
  - profileInit reuses the consultation model since both need higher reasoning capability
  - noUnusedLocals catches unused `vi` import from vitest and unused type-only imports
---

## 2026-02-02 - US-012
- Implemented tom/config.ts with Zod-validated ToM configuration schema and opt-in system
- TomConfigSchema: enabled (boolean, default false), consultThreshold (low|medium|high, default medium), models.memoryUpdate (string, default haiku), models.consultation (string, default sonnet), preferenceDecayDays (number, default 30), maxSessionsRetained (number, default 100)
- readTomConfig: reads tom key from ~/.claude/settings.json, validates with Zod, returns fully-defaulted config
- isTomEnabled: simple boolean guard for use in all hooks
- 18 new tests covering schema validation, config reading, defaults, error cases, isTomEnabled guard
- 232 total tests passing
- Files changed: tom/config.ts (new), tom/config.test.ts (new), prd.json, progress.txt
- **Learnings for future iterations:**
  - Zod z.strictObject with .default() on each field allows partial input with automatic defaults
  - Nested z.strictObject (models) also needs .default() on the outer field to handle when the entire key is missing
  - safeParse returns { success, data } on success — use to gracefully fall back to defaults on validation failure
  - This module centralizes config reading — existing isTomEnabled() in capture-interaction.ts and readTomSettings() in pre-tool-use.ts could be refactored to use this in a future iteration
---

## 2026-02-02 - US-013
- Implemented tom/pruning.ts with session pruning for Tier 1
- pruneOldSessions: reads all Tier 1 session files, sorts by startedAt, deletes oldest when count exceeds maxSessionsRetained
- Also deletes corresponding Tier 2 session models for pruned sessions
- Rebuilds BM25 index after pruning using buildMemoryIndex from agent/tools.ts
- Returns PruneResult with prunedSessionIds, before/after counts, and indexRebuilt flag
- 13 tests passing covering: no sessions, under limit, at limit, over limit, multiple pruning, missing models, edge cases
- 245 total tests passing
- Files changed: tom/pruning.ts (new), tom/pruning.test.ts (new), prd.json, progress.txt
- **Learnings for future iterations:**
  - listJsonFiles helper with try/catch is a common pattern — exists in agent/tools.ts and now pruning.ts (could be shared utility)
  - Session timestamps sorted by ISO string comparison work correctly since ISO 8601 is lexicographically sortable
  - fs.unlinkSync in try/catch for graceful handling of missing files (session models may not exist for every session)
  - BM25 index save pattern: write to {tomDir}/bm25-index.json — same pattern as stop-analyze.ts
  - pruneOldSessions is designed to be called from the Stop hook after session analysis completes
- Secret patterns duplicated in capture-interaction.ts and redaction.ts — consider consolidating to a shared module (tom/secrets.ts) in future refactor

## 2026-02-02 - US-014
- Implemented tom/redaction.ts with privacy redaction layer
- redactToolInput: takes tool input object, returns new object with secret values replaced by '[REDACTED]'
- redactUserMessage: strips inline code blocks, fenced code blocks, and URLs with query parameters
- 16 secret patterns matching: sk-*, ghp_*, gho_*, ghs_*, github_pat_*, Bearer, Basic, token, xox*, AKIA*, JWT, password=, npm_*, pypi-*, ENV_VAR=secret, API_KEY=value
- Values longer than 200 chars treated as file contents and redacted
- 31 tests passing covering all secret patterns, edge cases, user message redaction
- 276 total tests passing
- Files changed: tom/redaction.ts (new), tom/redaction.test.ts (new), prd.json, progress.txt
- **Learnings for future iterations:**
  - Secret patterns in redaction.ts mirror those in capture-interaction.ts — could be consolidated into shared module in future
  - Fenced code blocks must be replaced before inline code blocks to avoid partial matches
  - URL redaction only targets URLs with query params (?key=val) — plain URLs are kept since they don't leak secrets
  - redactToolInput has same shape-extraction behavior as extractParameterShape in capture-interaction.ts
---

## 2026-02-02 - US-015
- Implemented tom/skills/tom-status.ts with /tom status skill
- getStatus: reads merged user model, ToM config, and storage stats (Tier 1/2/3 file counts and sizes)
- formatStatus: renders human-readable markdown output with config, storage, top preferences, and style summaries
- Shows "No user model found" message when no Tier 3 model exists
- Top preferences sorted by confidence, limited to 10, displayed with percentage and session count
- formatBytes helper for human-readable file sizes (B, KB, MB)
- CLI entry point via main() writing to stdout
- 18 tests passing covering getStatus, formatStatus, main, byte formatting, edge cases
- 294 total tests passing
- Files changed: tom/skills/tom-status.ts (new), tom/skills/tom-status.test.ts (new), prd.json, progress.txt
- **Learnings for future iterations:**
  - Skills live in tom/skills/ directory — TypeScript modules with CLI entry points
  - When HOME and cwd point to same dir in tests, global and project paths overlap — use separate projectDir to avoid double-counting
  - countJsonFiles pattern: readdirSync + filter for .json extension, wrapped in try/catch for missing dirs
  - StatusOutput interface provides typed contract between getStatus (data) and formatStatus (presentation)
  - process.stdout.write can be intercepted in tests for CLI output verification
---

## 2026-02-02 - US-016
- Implemented tom/skills/tom-reset.ts with /tom reset skill
- performReset: recursively collects and deletes all files in ~/.claude/tom/ and .claude/tom/
- formatConfirmationPrompt: displays what will be deleted and asks for confirmation
- formatResetResult: shows summary of deleted data (file count, total size, per-scope breakdown)
- Handles overlapping global/project paths (when HOME equals cwd, project deletion is skipped)
- Does NOT delete settings.json (config preserved)
- CLI entry point: --confirm flag bypasses prompt and performs reset
- 21 tests passing covering empty state, global-only, project-only, both scopes, overlapping paths, settings preservation, formatting, CLI
- 315 total tests passing
- Files changed: tom/skills/tom-reset.ts (new), tom/skills/tom-reset.test.ts (new), prd.json, progress.txt
- **Learnings for future iterations:**
  - collectFiles recursive helper is useful for counting files before deletion
  - fs.rmSync with { recursive: true, force: true } handles non-existent directories gracefully
  - When global and project tom dirs resolve to the same path, skip project deletion to avoid double-counting
  - Skill CLI pattern: --confirm flag for destructive operations, default shows confirmation prompt
  - process.argv must be saved/restored in tests just like process.stdout.write and process.cwd
---
